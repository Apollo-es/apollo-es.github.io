<!doctype html>
<html lang="{{ page.lang | default: site.lang | default: 'es' }}" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  {% seo %}
  {% assign meta_description = page.description | default: page.excerpt | default: site.description %}
  {% if meta_description %}
    <meta name="description" content="{{ meta_description | strip_html | strip_newlines | replace: '  ', ' ' | escape }}">
  {% endif %}
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
  <meta name="googlebot" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
  {% assign keywords = page.keywords | default: site.keywords %}
  {% if keywords %}
    <meta name="keywords" content="{{ keywords | join: ', ' | escape }}">
  {% endif %}
  <meta property="og:locale" content="es_ES">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="author" content="{{ page.author | default: site.author | escape }}">
  <meta name="theme-color" content="#0b1020">
  {% if page.noindex or site.noindex %}
    <meta name="robots" content="noindex,nofollow">
  {% endif %}
  <link rel="canonical" href="{{ page.url | absolute_url }}">
  <link rel="icon" type="image/svg+xml" href="{{ site.favicon | default: '/favicon.svg' | relative_url }}">
  <link rel="apple-touch-icon" href="{{ site.favicon | default: '/favicon.svg' | relative_url }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
  {% if site.organization %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "{{ site.organization.name | default: site.title | escape }}",
      "url": "{{ site.organization.url | default: site.url | escape }}",
      {% if site.email %}"email": "{{ site.email | escape }}",
      {% endif %}
      {% if site.organization.logo or site.logo %}"logo": "{{ site.organization.logo | default: site.logo | absolute_url }}",
      {% endif %}
      {% if site.organization.same_as %}"sameAs": [{% for profile in site.organization.same_as %}"{{ profile | escape }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],{% endif %}
      "contactPoint": [{
        "@type": "ContactPoint",
        "contactType": "customer support",
        "email": "{{ site.email | escape }}",
        "availableLanguage": ["es"]
      }]
    }
    </script>
  {% endif %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "{{ site.title | escape }}",
    "url": "{{ site.url | append: site.baseurl }}",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "{{ site.url | append: site.baseurl | append: '/' }}?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  {% if site.nav %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "ItemList",
      "name": "Secciones de navegación de {{ site.title | escape }}",
      "itemListElement": [
        {% for item in site.nav %}
        {
          "@type": "SiteNavigationElement",
          "position": {{ forloop.index }},
          "name": "{{ item.name | escape }}",
          "url": "{{ item.url | absolute_url }}"
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }
    </script>
  {% endif %}
  {% assign raw_segments = page.url | default: '' | split: '/' %}
  {% assign clean_segments = '' %}
  {% for segment in raw_segments %}
    {% if segment != '' %}
      {% if clean_segments != '' %}
        {% assign clean_segments = clean_segments | append: '|' %}
      {% endif %}
      {% assign clean_segments = clean_segments | append: segment %}
    {% endif %}
  {% endfor %}
  {% if clean_segments != '' %}
    {% assign breadcrumb_segments = clean_segments | split: '|' %}
    {% assign path = '' %}
    {% assign position = 2 %}
    {% capture breadcrumb_items %}
      {"@type":"ListItem","position":1,"name":"Inicio","item":"{{ '/' | absolute_url }}"}
      {% for segment in breadcrumb_segments %}
        {% assign path = path | append: '/' | append: segment %}
        {% assign segment_url = path | append: '/' %}
        {% assign segment_name = segment | replace: '-', ' ' | capitalize %}
        {% for nav_item in site.nav %}
          {% if nav_item.url == segment_url %}
            {% assign segment_name = nav_item.name %}
          {% endif %}
        {% endfor %}
        {% if forloop.last %}
          {% assign segment_name = page.title | default: segment_name %}
          {% assign segment_url = page.url | absolute_url %}
        {% else %}
          {% assign segment_url = segment_url | absolute_url %}
        {% endif %}
        ,{"@type":"ListItem","position":{{ position }},"name":"{{ segment_name | strip | escape }}","item":"{{ segment_url }}"}
        {% assign position = position | plus: 1 %}
      {% endfor %}
    {% endcapture %}
    <script type="application/ld+json">{
      "@context":"https://schema.org",
      "@type":"BreadcrumbList",
      "itemListElement":[{{ breadcrumb_items | strip }}]
    }</script>
  {% endif %}
</head>
<body>
  <canvas id="bgfx" aria-hidden="true"></canvas>

  <header class="nav">
    <div class="brand">
      <a href="/"><span class="logo">A</span> <span class="brand-text">{{ site.title }}</span></a>
    </div>

    <div class="nav-right">
      {% assign home_item = site.nav | first %}
      {% if home_item %}
        <a class="nav-link nav-home{% if page.url == home_item.url %} active{% endif %}"
           href="{{ home_item.url }}">{{ home_item.name }}</a>
      {% endif %}

      <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="site-menu">
        <i class="ti ti-menu-2" aria-hidden="true"></i>
        <span class="sr-only">Abrir menú</span>
      </button>

      <div class="nav-overlay" data-nav-overlay hidden></div>

      <nav id="site-menu" class="nav-menu" aria-hidden="true" aria-label="Menú principal">
        <div class="nav-menu-card">
          <div class="nav-menu-header">
            <div class="nav-menu-brand">
              <span class="nav-menu-logo">A</span>
              <div class="nav-menu-copy">
                <span class="nav-menu-name">Apollo-es</span>
                <span class="nav-menu-tagline">Catálogo curado + IA en vivo</span>
              </div>
            </div>
            <button class="nav-close" type="button" data-nav-close>
              <i class="ti ti-x" aria-hidden="true"></i>
              <span class="sr-only">Cerrar menú</span>
            </button>
          </div>
          <p class="nav-menu-title">Explora</p>
          <div class="nav-menu-links">
            {% for item in site.nav offset:1 %}
              <a class="nav-link{% if page.url == item.url %} active{% endif %}"
                 href="{{ item.url }}">{{ item.name }}</a>
            {% endfor %}
          </div>
          <div class="nav-menu-footer">
            <p>¿Buscas algo concreto?</p>
            <a class="btn nav-menu-cta" href="#apollo-ai"><i class="ti ti-sparkles"></i> Habla con Apollo AI</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    {{ content }}
  </main>

  <footer class="footer">
    <p>© {{ site.time | date: "%Y" }} {{ site.title }} · Hecho con GitHub Pages</p>
    <a href="https://exe.io/ref/ApolloMG"><img src="https://exe.io/img/ref/r1.gif" title="CuT URLs - Earn money by shortening links with the highest CPMs Ever!" /></a>
  </footer>

  <button class="theme-toggle" type="button" data-theme-toggle aria-pressed="false" aria-label="Cambiar entre tema claro y oscuro">
    <i class="ti ti-moon-stars" aria-hidden="true"></i>
    <span class="sr-only">Alternar tema</span>
  </button>

  <button class="scroll-top" type="button" data-scroll-top aria-label="Volver arriba">
    <i class="ti ti-arrow-narrow-up" aria-hidden="true"></i>
    <span class="sr-only">Volver al inicio de la página</span>
  </button>

  <div id="report-panel" class="report-panel" hidden>
    <div class="report-panel-header">
      <div class="report-panel-title"><i class="ti ti-alert-triangle" aria-hidden="true"></i> Reportes internos</div>
      <span id="report-count" class="report-count">0</span>
    </div>
    <ol id="report-list" class="report-list">
      <li class="report-empty">Sin reportes registrados.</li>
    </ol>
    <div class="report-actions">
      <button type="button" id="report-clear" class="report-clear">
        <i class="ti ti-trash" aria-hidden="true"></i> Limpiar
      </button>
    </div>
  </div>

  <div class="auth-controls">
    <span data-user-box>No has iniciado sesión</span>
    <button type="button" data-login-google>Entrar con Google</button>
    <button type="button" data-logout>Salir</button>
  </div>

  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/chatbot.js"></script>

  <!-- Firebase App (Auth + Firestore + tracking) -->
  <script type="module">
    import {
      onAuth, loginWithGoogle, logout,
      trackDownload, trackForumActivity,
      getUserDownloadCount, getGlobalDownloadCountForFile
    } from "/assets/js/firebase-app.js";

    // UI mínima
    const loginBtn  = document.querySelector('[data-login-google]');
    const logoutBtn = document.querySelector('[data-logout]');
    const userBox   = document.querySelector('[data-user-box]');

    if (loginBtn)  loginBtn.addEventListener('click', () => loginWithGoogle().catch(console.error));
    if (logoutBtn) logoutBtn.addEventListener('click', () => logout().catch(console.error));

    onAuth(async (user) => {
      if (userBox) {
        userBox.textContent = user ? `Hola, ${user.displayName || user.email}` : 'No has iniciado sesión';
        document.body.classList.toggle('logged-in', !!user);
      }
    });

    // Auto-tracking de descargas: cualquier link con data-track-download
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-track-download]');
      if (!a) return;
      const fileId   = a.getAttribute('data-file-id')   || a.href;
      const fileName = a.getAttribute('data-file-name') || a.textContent.trim();
      trackDownload({ fileId, fileName }).catch(console.error);
    });

    // Ejemplo de uso manual en el foro:
    // trackForumActivity({ threadId: 'X', action: 'post' });
  </script>
</body>
</html>
