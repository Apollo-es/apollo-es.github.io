<!doctype html>
<html lang="{{ page.lang | default: site.lang | default: 'es' }}" data-theme="dark" data-recaptcha-site-key="{{ site.recaptcha.site_key | default: '' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  {% seo %}
  {% assign meta_description = page.description | default: page.excerpt | default: site.description %}
  {% if meta_description %}
    <meta name="description" content="{{ meta_description | strip_html | strip_newlines | replace: '  ', ' ' | escape }}">
  {% endif %}
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
  <meta name="googlebot" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
  {% assign keywords = page.keywords | default: site.keywords %}
  {% if keywords %}
    <meta name="keywords" content="{{ keywords | join: ', ' | escape }}">
  {% endif %}
  <meta property="og:locale" content="es_ES">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="author" content="{{ page.author | default: site.author | escape }}">
  <meta name="theme-color" content="#0b1020">
  {% if page.noindex or site.noindex %}
    <meta name="robots" content="noindex,nofollow">
  {% endif %}
  <link rel="canonical" href="{{ page.url | absolute_url }}">
  <link rel="icon" type="image/svg+xml" href="{{ site.favicon | default: '/favicon.svg' | relative_url }}">
  <link rel="apple-touch-icon" href="{{ site.favicon | default: '/favicon.svg' | relative_url }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
  {% if site.recaptcha.site_key %}
  <script src="https://www.google.com/recaptcha/enterprise.js?render={{ site.recaptcha.site_key }}"></script>
  {% endif %}
  {% if site.organization %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "{{ site.organization.name | default: site.title | escape }}",
      "url": "{{ site.organization.url | default: site.url | escape }}",
      {% if site.email %}"email": "{{ site.email | escape }}",
      {% endif %}
      {% if site.organization.logo or site.logo %}"logo": "{{ site.organization.logo | default: site.logo | absolute_url }}",
      {% endif %}
      {% if site.organization.same_as %}"sameAs": [{% for profile in site.organization.same_as %}"{{ profile | escape }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],{% endif %}
      "contactPoint": [{
        "@type": "ContactPoint",
        "contactType": "customer support",
        "email": "{{ site.email | escape }}",
        "availableLanguage": ["es"]
      }]
    }
    </script>
  {% endif %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "{{ site.title | escape }}",
    "url": "{{ site.url | append: site.baseurl }}",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "{{ site.url | append: site.baseurl | append: '/' }}?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  {% if site.nav %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "ItemList",
      "name": "Secciones de navegación de {{ site.title | escape }}",
      "itemListElement": [
        {% for item in site.nav %}
        {
          "@type": "SiteNavigationElement",
          "position": {{ forloop.index }},
          "name": "{{ item.name | escape }}",
          "url": "{{ item.url | absolute_url }}"
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }
    </script>
  {% endif %}
  {% assign raw_segments = page.url | default: '' | split: '/' %}
  {% assign clean_segments = '' %}
  {% for segment in raw_segments %}
    {% if segment != '' %}
      {% if clean_segments != '' %}
        {% assign clean_segments = clean_segments | append: '|' %}
      {% endif %}
      {% assign clean_segments = clean_segments | append: segment %}
    {% endif %}
  {% endfor %}
  {% if clean_segments != '' %}
    {% assign breadcrumb_segments = clean_segments | split: '|' %}
    {% assign path = '' %}
    {% assign position = 2 %}
    {% capture breadcrumb_items %}
      {"@type":"ListItem","position":1,"name":"Inicio","item":"{{ '/' | absolute_url }}"}
      {% for segment in breadcrumb_segments %}
        {% assign path = path | append: '/' | append: segment %}
        {% assign segment_url = path | append: '/' %}
        {% assign segment_name = segment | replace: '-', ' ' | capitalize %}
        {% for nav_item in site.nav %}
          {% if nav_item.url == segment_url %}
            {% assign segment_name = nav_item.name %}
          {% endif %}
        {% endfor %}
        {% if forloop.last %}
          {% assign segment_name = page.title | default: segment_name %}
          {% assign segment_url = page.url | absolute_url %}
        {% else %}
          {% assign segment_url = segment_url | absolute_url %}
        {% endif %}
        ,{"@type":"ListItem","position":{{ position }},"name":"{{ segment_name | strip | escape }}","item":"{{ segment_url }}"}
        {% assign position = position | plus: 1 %}
      {% endfor %}
    {% endcapture %}
    <script type="application/ld+json">{
      "@context":"https://schema.org",
      "@type":"BreadcrumbList",
      "itemListElement":[{{ breadcrumb_items | strip }}]
    }</script>
  {% endif %}
</head>
<body>
  <canvas id="bgfx" aria-hidden="true"></canvas>

  <header class="nav">
    <div class="brand">
      <a href="/"><span class="logo">A</span> <span class="brand-text">{{ site.title }}</span></a>
    </div>

    <div class="nav-right">

      <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="site-menu">
        <i class="ti ti-menu-2" aria-hidden="true"></i>
        <span class="sr-only">Abrir menú</span>
      </button>

      <div class="nav-overlay" data-nav-overlay hidden></div>

      <nav id="site-menu" class="nav-menu" aria-hidden="true" aria-label="Menú principal">
        <div class="nav-menu-card">
          <div class="nav-menu-header">
            <div class="nav-menu-brand">
              <span class="nav-menu-logo">A</span>
              <div class="nav-menu-copy">
                <span class="nav-menu-name">Apollo-es</span>
                <span class="nav-menu-tagline">Catálogo curado + IA en vivo</span>
              </div>
            </div>
            <button class="nav-close" type="button" data-nav-close>
              <i class="ti ti-x" aria-hidden="true"></i>
              <span class="sr-only">Cerrar menú</span>
            </button>
          </div>
          <div class="nav-menu-account" data-auth-block>
            <div class="nav-menu-guest" data-guest-summary>
              <div class="nav-menu-guest-copy">
                <span class="nav-menu-avatar" aria-hidden="true"><i class="ti ti-sparkles"></i></span>
                <div>
                  <span class="nav-menu-user-label">Bienvenido</span>
                  <strong>Descubre todo el catálogo</strong>
                </div>
              </div>
              <p>Inicia sesión para sincronizar tus favoritos y continuar donde lo dejaste.</p>
              <button class="btn nav-menu-account-btn primary" type="button" data-open-login>
                <i class="ti ti-login" aria-hidden="true"></i>
                Iniciar sesión
              </button>
              <span class="nav-menu-guest-note">¿Nuevo aquí? Crea tu cuenta gratis en segundos.</span>
            </div>
          </div>
          <p class="nav-menu-title">Explora</p>
          <div class="nav-menu-links">
            {% assign nav_items = site.nav | where_exp: 'item', 'item.url != "/"' %}
            {% for item in nav_items %}
              <a class="nav-link{% if page.url == item.url %} active{% endif %}"
                 href="{{ item.url }}">{{ item.name }}</a>
            {% endfor %}
          </div>
          <div class="nav-menu-footer">
            <p>¿Buscas algo concreto?</p>
            <a class="btn nav-menu-cta" href="#apollo-ai"><i class="ti ti-sparkles"></i> Habla con Apollo AI</a>
          </div>
        </div>
      </nav>
    </div>

    <div class="auth-head">
      <div class="user-dropdown" data-user-menu hidden>
        <button class="user-trigger" type="button" data-user-trigger aria-haspopup="true" aria-expanded="false">
          <span>Hola, <strong data-username>Usuario</strong></span>
          <i class="ti ti-chevron-down" aria-hidden="true"></i>
        </button>
        <div class="user-menu" hidden data-user-panel role="menu">
          <ul class="user-menu-list" role="none">
            <li role="none">
              <a class="user-menu-item" href="/account.html" role="menuitem">
                <i class="ti ti-id-badge" aria-hidden="true"></i>
                <span>Mi cuenta</span>
              </a>
            </li>
            <li role="none">
              <button class="user-menu-item" type="button" data-logout role="menuitem">
                <i class="ti ti-logout" aria-hidden="true"></i>
                <span>Cerrar sesión</span>
              </button>
            </li>
          </ul>
        </div>
      </div>

      <button type="button" data-open-login>Iniciar sesión</button>
    </div>
  </header>

  <main class="container">
    {{ content }}
  </main>

  <div class="like-coach" data-like-hint hidden role="dialog" aria-live="polite" aria-label="Consejo para guardar contenidos">
    <div class="like-coach-card">
      <span class="like-coach-icon" aria-hidden="true">❤</span>
      <div class="like-coach-copy">
        <strong>Guarda con «Me gusta»</strong>
        <p>¿Quieres guardarte un juego o una app? Haz clic en «Me gusta» para que se quede en tu perfil.</p>
        <button class="like-coach-action" type="button" data-like-hint-close>Entendido</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>© {{ site.time | date: "%Y" }} {{ site.title }} · Hecho con GitHub Pages</p>
    <a href="https://exe.io/ref/ApolloMG"><img src="https://exe.io/img/ref/r1.gif" title="CuT URLs - Earn money by shortening links with the highest CPMs Ever!" /></a>
  </footer>

  <button class="theme-toggle" type="button" data-theme-toggle aria-pressed="false" aria-label="Cambiar entre tema claro y oscuro">
    <i class="ti ti-moon-stars" aria-hidden="true"></i>
    <span class="sr-only">Alternar tema</span>
  </button>

  <button class="scroll-top" type="button" data-scroll-top aria-label="Volver arriba">
    <i class="ti ti-arrow-narrow-up" aria-hidden="true"></i>
    <span class="sr-only">Volver al inicio de la página</span>
  </button>

  <div id="report-panel" class="report-panel" hidden>
    <div class="report-panel-header">
      <div class="report-panel-title"><i class="ti ti-alert-triangle" aria-hidden="true"></i> Reportes internos</div>
      <span id="report-count" class="report-count">0</span>
    </div>
    <ol id="report-list" class="report-list">
      <li class="report-empty">Sin reportes registrados.</li>
    </ol>
    <div class="report-actions">
      <button type="button" id="report-clear" class="report-clear">
        <i class="ti ti-trash" aria-hidden="true"></i> Limpiar
      </button>
    </div>
  </div>

  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/chatbot.js"></script>
  <script src="/assets/js/recaptcha.js"></script>
  <div class="modal-backdrop" data-login-modal hidden>
    <div class="modal">
      <button class="modal-close" type="button" data-close-login aria-label="Cerrar">×</button>
      <h2>Inicia sesión</h2>

      <button class="btn-google" type="button" data-login-google>Continuar con Google</button>

      <div class="or">o</div>

      <form id="email-login-form" data-recaptcha="modal-auth" data-recaptcha-action="login">
        <label>Email</label>
        <input type="email" id="email" required autocomplete="username">
        <label>Contraseña</label>
        <input type="password" id="password" required minlength="6" autocomplete="current-password">
        <label data-register-only hidden>Confirmar contraseña</label>
        <input type="password" id="password-confirm" data-register-only hidden autocomplete="new-password">
        <p class="password-strength" data-password-strength hidden></p>
        <div class="security-challenge" data-register-only hidden>
          <p class="security-question" data-security-question></p>
          <div class="security-challenge-controls">
            <input type="text" id="security-answer" inputmode="numeric" autocomplete="one-time-code">
            <button type="button" data-refresh-challenge aria-label="Nuevo reto"><i class="ti ti-refresh"></i></button>
          </div>
        </div>
        <label class="security-consent" data-register-only hidden>
          <input type="checkbox" id="security-consent">
          Confirmo que soy una persona y acepto los términos de seguridad.
        </label>
        <input type="hidden" name="g-recaptcha-response" data-recaptcha-token>
        <div class="actions">
          <button type="submit"
                  class="g-recaptcha"
                  data-sitekey="{{ site.recaptcha.site_key | default: '' }}"
                  data-action="login"
                  data-callback="onRecaptchaSubmit"
                  data-recaptcha-form="email-login-form">Entrar</button>
          <button type="button" data-toggle-mode>Crear cuenta</button>
        </div>
        <button type="button" class="link" data-reset>¿Olvidaste tu contraseña?</button>
        <p id="login-error" class="error" role="alert"></p>
        <p class="warning" data-attempt-warning></p>
      </form>
    </div>
  </div>

  <script type="module">
    import {
      onAuth, loginWithGoogle,
      loginEmailPass, registerEmailPass, resetPassword
    } from "/assets/js/firebase-app.js";
    import {
      AttemptGuard,
      SecurityChallenge,
      formatDuration
    } from "/assets/js/auth-security.js";

    const openButtons = Array.from(document.querySelectorAll("[data-open-login]"));
    const modal     = document.querySelector("[data-login-modal]");
    const closeBtn  = document.querySelector("[data-close-login]");
    const loginG    = document.querySelector("[data-login-google]");

    const form = document.getElementById("email-login-form");
    const email = document.getElementById("email");
    const pass  = document.getElementById("password");
    const passConfirm = document.getElementById("password-confirm");
    const errorBox = document.getElementById("login-error");
    const warningBox = document.querySelector("[data-attempt-warning]");
    const resetBtn = document.querySelector("[data-reset]");
    const toggleModeBtn = form.querySelector("[data-toggle-mode]");
    const registerOnly = Array.from(form.querySelectorAll("[data-register-only]"));
    const submitBtn = form.querySelector("button[type='submit']");
    const strengthBox = form.querySelector("[data-password-strength]");
    const securityQuestion = form.querySelector("[data-security-question]");
    const securityAnswer = document.getElementById("security-answer");
    const refreshChallengeBtn = form.querySelector("[data-refresh-challenge]");
    const securityConsent = document.getElementById("security-consent");
    const recaptchaField = form.querySelector("[data-recaptcha-token]");

    const loginGuard = new AttemptGuard("login", {
      baseCooldownMs: 15000,
      backoffFactor: 2,
      lockoutThreshold: 6,
      lockoutMs: 15 * 60 * 1000,
      resetMs: 5 * 60 * 1000,
      maxCooldownMs: 60 * 60 * 1000
    });

    const registerGuard = new AttemptGuard("register", {
      baseCooldownMs: 60000,
      backoffFactor: 2.4,
      lockoutThreshold: 3,
      lockoutMs: 45 * 60 * 1000,
      resetMs: 30 * 60 * 1000,
      maxCooldownMs: 6 * 60 * 60 * 1000
    });

    const challenge = new SecurityChallenge();

    const getRecaptchaManager = () => window.ApolloRecaptcha || null;

    const clearRecaptchaToken = () => {
      if (recaptchaField) recaptchaField.value = "";
      const manager = getRecaptchaManager();
      if (manager && typeof manager === "object") {
        if (Object.prototype.hasOwnProperty.call(manager, "lastToken")) {
          manager.lastToken = null;
        }
        if (Object.prototype.hasOwnProperty.call(manager, "lastForm") && manager.lastForm === form) {
          manager.lastForm = null;
        }
        if (Object.prototype.hasOwnProperty.call(manager, "lastButton") && manager.lastButton === submitBtn) {
          manager.lastButton = null;
        }
      }
    };

    const ensureRecaptchaToken = async (action) => {
      const existing = recaptchaField ? recaptchaField.value.trim() : "";
      if (existing) return existing;
      const manager = getRecaptchaManager();
      if (!manager) {
        errorBox.textContent = "No se pudo inicializar la protección reCAPTCHA.";
        return "";
      }
      try {
        const token = await manager.execute(action);
        if (typeof window.onRecaptchaSubmit === "function") {
          window.onRecaptchaSubmit(token, { action, form, manual: true });
        } else if (recaptchaField) {
          recaptchaField.value = token;
        }
        return token;
      } catch (error) {
        console.error("Error al obtener el token reCAPTCHA", error);
        errorBox.textContent = "No se pudo verificar reCAPTCHA. Inténtalo de nuevo.";
        return "";
      }
    };

    const state = {
      mode: "login",
      processing: false
    };

    const texts = {
      login: { submit: "Entrar", toggle: "Crear cuenta" },
      register: { submit: "Crear cuenta", toggle: "Ya tengo cuenta" }
    };

    const setWarning = (message = "") => {
      if (warningBox) warningBox.textContent = message;
    };

    const formatBlockedMessage = (guard) => {
      const status = guard.canAttempt();
      if (status.allowed) return "";
      const wait = formatDuration(status.waitMs);
      return `Demasiados intentos. Vuelve a intentarlo en ${wait}.`;
    };

    const disableForm = (disabled) => {
      state.processing = disabled;
      const elements = [submitBtn, toggleModeBtn, loginG, resetBtn, securityAnswer, securityConsent, pass, passConfirm, email];
      elements.filter(Boolean).forEach((el) => {
        el.disabled = disabled;
      });
    };

    const toggleRegisterFields = (show) => {
      registerOnly.forEach((element) => {
        element.hidden = !show;
        const input = element.tagName === "INPUT" ? element : element.querySelector("input");
        if (input) input.required = show;
      });
      if (strengthBox) strengthBox.hidden = !show;
    };

    const refreshChallenge = async () => {
      if (!securityQuestion) return;
      const question = await challenge.generate();
      securityQuestion.textContent = question;
      if (securityAnswer) securityAnswer.value = "";
    };

    const setMode = (mode) => {
      state.mode = mode;
      if (form) {
        form.setAttribute("data-recaptcha-action", mode);
      }
      if (submitBtn) {
        submitBtn.setAttribute("data-action", mode);
      }
      toggleRegisterFields(mode === "register");
      submitBtn.textContent = texts[mode].submit;
      toggleModeBtn.textContent = texts[mode].toggle;
      if (pass) {
        pass.setAttribute("autocomplete", mode === "register" ? "new-password" : "current-password");
      }
      if (mode === "register") {
        refreshChallenge().catch(console.error);
        updatePasswordStrength();
      } else {
        setWarning("");
        if (strengthBox) strengthBox.textContent = "";
        if (passConfirm) passConfirm.value = "";
        if (securityAnswer) securityAnswer.value = "";
        if (securityConsent) securityConsent.checked = false;
      }
      clearRecaptchaToken();
    };

    const strengthMessages = [
      "Contraseña muy débil",
      "Contraseña débil",
      "Contraseña aceptable",
      "Contraseña segura"
    ];

    const calculateStrength = (value) => {
      let score = 0;
      if (value.length >= 12) score++;
      if (/[A-Z]/.test(value)) score++;
      if (/[a-z]/.test(value) && /\d/.test(value)) score++;
      if (/[^A-Za-z0-9]/.test(value)) score++;
      return score;
    };

    const updatePasswordStrength = () => {
      if (!strengthBox) return;
      const value = pass.value;
      if (!value) {
        strengthBox.textContent = "";
        return;
      }
      const score = calculateStrength(value);
      strengthBox.textContent = strengthMessages[Math.min(score, strengthMessages.length - 1)];
    };

    const mapFirebaseError = (err) => {
      const errorCode = err?.code || "";
      const translations = {
        "auth/invalid-email": "El email no es válido.",
        "auth/user-not-found": "No existe ninguna cuenta con ese email.",
        "auth/wrong-password": "La contraseña no coincide.",
        "auth/too-many-requests": "Acceso temporalmente bloqueado. Inténtalo más tarde.",
        "auth/email-already-in-use": "Ya existe una cuenta con ese email.",
        "auth/weak-password": "La contraseña es demasiado débil.",
        "auth/network-request-failed": "Error de red. Comprueba tu conexión.",
        "auth/popup-closed-by-user": "Se canceló el inicio de sesión."
      };
      return translations[errorCode] || err?.message || "Ocurrió un error inesperado.";
    };

    const shouldCountGuardFailure = (err) => {
      const code = err?.code || "";
      return !["auth/popup-closed-by-user", "auth/cancelled-popup-request"].includes(code);
    };

    const requireStrongPassword = () => {
      const value = pass.value;
      const confirm = passConfirm?.value || "";
      const errors = [];
      if (value.length < 12) errors.push("al menos 12 caracteres");
      if (!/[A-Z]/.test(value)) errors.push("una mayúscula");
      if (!/[a-z]/.test(value) || !/\d/.test(value)) errors.push("letras minúsculas y números");
      if (!/[^A-Za-z0-9]/.test(value)) errors.push("un símbolo");
      if (confirm && value !== confirm) errors.push("que las contraseñas coincidan");
      if (errors.length) {
        errorBox.textContent = `La contraseña debe incluir ${errors.join(", ")}.`;
        return false;
      }
      return true;
    };

    const ensureChallengeSolved = async () => {
      if (!securityAnswer) return true;
      const valid = await challenge.verify(securityAnswer.value);
      if (!valid) {
        errorBox.textContent = "Reto de seguridad incorrecto.";
        await refreshChallenge();
        return false;
      }
      return true;
    };

    const ensureConsent = () => {
      if (!securityConsent) return true;
      if (!securityConsent.checked) {
        errorBox.textContent = "Debes aceptar las medidas de seguridad.";
        return false;
      }
      return true;
    };

    function showLoginModal(){
      modal.hidden = false;
      document.body.style.overflow='hidden';
      errorBox.textContent="";
      setWarning("");
      if (state.mode === "register") {
        refreshChallenge().catch(console.error);
      }
    }

    window.openLoginModal = showLoginModal;

    openButtons.forEach((btn) => {
      btn.addEventListener("click", showLoginModal);
    });
    closeBtn?.addEventListener("click", () => {
      modal.hidden = true;
      document.body.style.overflow='';
      setMode("login");
    });
    modal?.addEventListener("click", (e)=>{ if(e.target===modal) { modal.hidden = true; document.body.style.overflow=''; setMode("login"); } });

    loginG?.addEventListener("click", async () => {
      setWarning("");
      errorBox.textContent = "";
      const status = loginGuard.canAttempt();
      if (!status.allowed) {
        errorBox.textContent = formatBlockedMessage(loginGuard);
        return;
      }
      disableForm(true);
      try {
        const token = await ensureRecaptchaToken("login_google");
        if (!token) return;
        await loginWithGoogle();
        loginGuard.recordSuccess();
        setMode("login");
        modal.hidden = true;
        document.body.style.overflow='';
      } catch(e){
        errorBox.textContent = mapFirebaseError(e);
        if (shouldCountGuardFailure(e)) {
          const delay = loginGuard.recordFailure();
          setWarning(`Protección activada durante ${formatDuration(delay)}.`);
        }
      } finally {
        clearRecaptchaToken();
        disableForm(false);
      }
    });

    toggleModeBtn?.addEventListener("click", () => {
      const nextMode = state.mode === "login" ? "register" : "login";
      setMode(nextMode);
    });

    pass.addEventListener("input", updatePasswordStrength);
    passConfirm?.addEventListener("input", updatePasswordStrength);

    refreshChallengeBtn?.addEventListener("click", () => {
      refreshChallenge().catch(console.error);
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (state.processing) return;
      errorBox.textContent = "";
      setWarning("");

      if (state.mode === "login") {
        const status = loginGuard.canAttempt();
        if (!status.allowed) {
          errorBox.textContent = formatBlockedMessage(loginGuard);
          return;
        }
        disableForm(true);
        try {
          const token = await ensureRecaptchaToken("login");
          if (!token) return;
          await loginEmailPass(email.value.trim(), pass.value);
          loginGuard.recordSuccess();
          setMode("login");
          modal.hidden = true;
          document.body.style.overflow='';
        }
        catch (err) {
          const delay = loginGuard.recordFailure();
          errorBox.textContent = mapFirebaseError(err);
          setWarning(`Debes esperar ${formatDuration(delay)} antes del próximo intento.`);
        }
        finally {
          clearRecaptchaToken();
          disableForm(false);
        }
        return;
      }

      const status = registerGuard.canAttempt();
      if (!status.allowed) {
        errorBox.textContent = formatBlockedMessage(registerGuard);
        return;
      }

      if (!requireStrongPassword()) {
        return;
      }

      if (!await ensureChallengeSolved()) {
        const delay = registerGuard.recordFailure();
        setWarning(`Intento bloqueado durante ${formatDuration(delay)}.`);
        return;
      }

      if (!ensureConsent()) {
        return;
      }

      const token = await ensureRecaptchaToken("register");
      if (!token) {
        return;
      }

      disableForm(true);
      try {
        await registerEmailPass(email.value.trim(), pass.value);
        registerGuard.recordSuccess();
        setMode("login");
        modal.hidden = true;
        document.body.style.overflow='';
      }
      catch (err) {
        const delay = registerGuard.recordFailure();
        errorBox.textContent = mapFirebaseError(err);
        setWarning(`Debes esperar ${formatDuration(delay)} antes de volver a intentarlo.`);
        await refreshChallenge();
      }
      finally {
        clearRecaptchaToken();
        disableForm(false);
      }
    });

    resetBtn.addEventListener("click", async () => {
      if (!email.value) { errorBox.textContent = "Escribe tu email."; return; }
      disableForm(true);
      try {
        const token = await ensureRecaptchaToken("password_reset");
        if (!token) return;
        await resetPassword(email.value.trim());
        errorBox.textContent = "Revisa tu correo para continuar.";
      }
      catch (err) {
        errorBox.textContent = mapFirebaseError(err);
      }
      finally {
        clearRecaptchaToken();
        disableForm(false);
      }
    });

    onAuth((user) => {
      document.body.classList.toggle("logged-in", !!user);
    });

    setMode("login");
  </script>

  <script type="module">
    import { onAuth, logout } from "/assets/js/firebase-app.js";

    const menuWrap = document.querySelector("[data-user-menu]");
    const trigger  = document.querySelector("[data-user-trigger]");
    const panel    = document.querySelector("[data-user-panel]");
    const usernameNodes = Array.from(document.querySelectorAll("[data-username]"));
    const logoutButtons = Array.from(document.querySelectorAll("[data-logout]"));
    const authBlock = document.querySelector("[data-auth-block]");
    const guestSummary = document.querySelector("[data-guest-summary]");

    trigger?.addEventListener("click", (event) => {
      event.preventDefault();
      if (!panel) return;
      const expanded = panel.hidden;
      panel.hidden = !panel.hidden;
      trigger.setAttribute("aria-expanded", String(expanded));
    });

    document.addEventListener("click", (e)=>{
      if(!panel || panel.hidden) return;
      if(!e.target.closest("[data-user-menu]")){
        panel.hidden = true;
        trigger?.setAttribute("aria-expanded", "false");
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Escape" || !panel || panel.hidden) return;
      panel.hidden = true;
      trigger?.setAttribute("aria-expanded", "false");
      trigger?.focus();
    });

    const navToggleButton = document.querySelector(".nav-toggle");

    logoutButtons.forEach((button) => {
      button.addEventListener("click", (event) => {
        event.preventDefault();
        if (panel) panel.hidden = true;
        trigger?.setAttribute("aria-expanded", "false");
        if (navToggleButton?.getAttribute("aria-expanded") === "true") {
          navToggleButton.click();
        }
        logout().catch(console.error);
      });
    });

    onAuth((user)=>{
      const logged = !!user;
      if (menuWrap) menuWrap.hidden = !logged;
      if (panel) panel.hidden = true;
      trigger?.setAttribute("aria-expanded", "false");
      const displayName = (user?.displayName) || (user?.email) || "Usuario";
      usernameNodes.forEach((node) => {
        node.textContent = displayName;
      });
      if (authBlock) authBlock.hidden = logged;
      if (guestSummary) guestSummary.hidden = logged;
    });
  </script>

  <script type="module">
    import { trackDownload } from "/assets/js/firebase-app.js";

    document.addEventListener("click", (event) => {
      const link = event.target.closest("a[data-track-download]");
      if (!link) return;
      const fileId = link.getAttribute("data-file-id") || link.href;
      const fileName = link.getAttribute("data-file-name") || link.textContent.trim();
      trackDownload({ fileId, fileName }).catch(console.error);
    });
  </script>

  <script type="module">
    import { onAuth, requireAuth, toggleLike, setRating, listFavorites } from "/assets/js/firebase-app.js";

    if (typeof window.openLoginModal !== "function") {
      window.openLoginModal = () => {
        const modal = document.querySelector("[data-login-modal]");
        if (modal) modal.hidden = false;
        document.body.style.overflow = "hidden";
      };
    }

    function getPayload(node){
      const wrap = node?.closest?.("[data-content]");
      const rawId = wrap?.dataset.id || location.pathname.replace(/\W+/g, "-");
      return {
        contentType: wrap?.dataset.type || "game",
        contentId: rawId,
        title: wrap?.dataset.title || document.title
      };
    }

    function ensureAuth(){
      return requireAuth(window.openLoginModal);
    }

    const likeHint = document.querySelector("[data-like-hint]");
    const likeHintClose = likeHint?.querySelector("[data-like-hint-close]");
    const likeHintBubble = document.querySelector("[data-like-hint-bubble]");
    let likeHintHideTimer = null;
    let likeHintKey = null;

    const likeHintClass = "is-visible";

    function setLikeHintVisible(visible){
      if (likeHint) {
        if (visible) {
          likeHint.hidden = false;
          window.requestAnimationFrame(() => likeHint.classList.add(likeHintClass));
        } else {
          likeHint.classList.remove(likeHintClass);
          window.clearTimeout(likeHintHideTimer);
          likeHintHideTimer = window.setTimeout(() => {
            likeHint.hidden = true;
          }, 260);
        }
      }
      if (likeHintBubble) {
        likeHintBubble.hidden = !visible;
        likeHintBubble.classList.toggle(likeHintClass, visible);
      }
      document.body.classList.toggle("like-hint-visible", !!visible);
    }

    function rememberHintDismiss(key){
      if (!key) return;
      try {
        localStorage.setItem(key, "1");
      } catch (error) {
        console.warn("No se pudo guardar la preferencia de ayuda", error);
      }
    }

    function shouldShowHint(key){
      if (!key) return false;
      try {
        return localStorage.getItem(key) !== "1";
      } catch (error) {
        console.warn("No se pudo leer la preferencia de ayuda", error);
        return true;
      }
    }

    function hideLikeHint(options = {}){
      const { persist = false } = options;
      if (persist) rememberHintDismiss(likeHintKey);
      setLikeHintVisible(false);
    }

    likeHintClose?.addEventListener("click", () => {
      hideLikeHint({ persist: true });
    });

    async function evaluateLikeHint(user){
      if (!user) {
        likeHintKey = null;
        hideLikeHint();
        return;
      }
      likeHintKey = `like-hint-dismissed::${user.uid}`;
      if (!shouldShowHint(likeHintKey)) {
        hideLikeHint();
        return;
      }
      try {
        const favorites = await listFavorites({ limit: 1 });
        if (favorites.length > 0) {
          rememberHintDismiss(likeHintKey);
          hideLikeHint();
          return;
        }
        setLikeHintVisible(true);
      } catch (error) {
        console.warn("No se pudo cargar el estado de favoritos", error);
      }
    }

    onAuth((user) => {
      evaluateLikeHint(user).catch((error) => {
        console.warn("No se pudo evaluar la ayuda de favoritos", error);
      });
    });

    document.addEventListener("click", async (event) => {
      const likeBtn = event.target.closest("[data-like]");
      if (likeBtn) {
        if (!ensureAuth()) return;
        const payload = getPayload(likeBtn);
        try {
          const result = await toggleLike(payload);
          likeBtn.classList.toggle("active", !!result.liked);
          if (result.liked) {
            hideLikeHint({ persist: true });
          }
          document.dispatchEvent(new CustomEvent("apollo:favorites-updated"));
        } catch (error) {
          console.error("like failed", error);
        }
      }

      const star = event.target.closest("[data-star]");
      if (star) {
        const ratingWrap = star.closest("[data-rate]");
        if (!ratingWrap) return;
        if (!ensureAuth()) return;
        const rating = parseInt(star.dataset.star || "0", 10);
        const payload = { ...getPayload(star), rating };
        try {
          await setRating(payload);
          const stars = ratingWrap.querySelectorAll("[data-star]");
          stars.forEach((button) => {
            const value = parseInt(button.dataset.star || "0", 10);
            button.classList.toggle("active", value <= rating);
          });
          document.dispatchEvent(new CustomEvent("apollo:favorites-updated"));
        } catch (error) {
          console.error("rating failed", error);
        }
      }
    });
  </script>

  <script type="module">
    import { sendReport } from "/assets/js/firebase-app.js";

    document.addEventListener("apollo:report-created", (event) => {
      const detail = event.detail || {};
      const parts = [];
      if (detail.title) parts.push(detail.title);
      if (detail.host) parts.push(`host: ${detail.host}`);
      if (detail.group) parts.push(`grupo: ${detail.group}`);
      const message = detail.message || `Reporte de enlace: ${parts.join(" · ") || detail.item || "sin título"}`;
      const context = detail.url || location.pathname;
      sendReport({ message, context }).catch(console.error);
    });
  </script>
</body>
</html>
